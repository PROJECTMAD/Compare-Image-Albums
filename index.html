<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Music Albums v5</title>
    <script src="https://cdn.tailwindcss.com/3.4.1"></script>
    <style>
        /* Custom scrollbar for a cleaner look */
        #albums-grid::-webkit-scrollbar { width: 8px; }
        #albums-grid::-webkit-scrollbar-track { background: transparent; }
        #albums-grid::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 4px; }
        #albums-grid::-webkit-scrollbar-thumb:hover { background: #4338ca; }

        /* Album Cards */
        #albums-grid .album-card { width: 270px; height: calc(270px * 1.7); aspect-ratio: 1.7; }
        #albums-grid .album-title { overflow: hidden; text-overflow: ellipsis; text-align: center; white-space: nowrap; }

        .image { flex: 1; height: 405px; width: 270px; object-fit: cover; object-position: top; aspect-ratio: 1.46; transition: transform 400ms ease; }
        .image.top { object-position: top center; }

        /* Animation for the detail panel and backdrop */
        #album-detail-container, #detail-backdrop { opacity: 0; transition: opacity 0.3s ease-out; pointer-events: none; }
        #album-detail-container.expanded, #detail-backdrop.expanded { opacity: 1; pointer-events: auto; }
        #album-detail-container { transform: translateY(20px); transition-property: opacity, transform; transition-duration: 0.3s; }
        #album-detail-container.expanded { transform: translateY(0); }

        /* Skeleton Loading Animation */
        @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        .skeleton-loader { overflow: hidden; background-color: #4f5570; }
        .dark .skeleton-loader { background-color: #374151; }
        .skeleton-loader::after { content: ''; position: absolute; top: 0; right: 0; bottom: 0; left: 0; background: linear-gradient(90deg, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0) 100%); animation: shimmer 1.5s infinite; }
        .dark .skeleton-loader::after { background: linear-gradient(90deg, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.05) 50%, rgba(255, 255, 255, 0) 100%); }

        /* Ensures the image fades in smoothly */
        .lazy-image { opacity: 0; transition: opacity 0.4s ease-in-out; }
        .lazy-image.loaded { opacity: 1; }

        /* --- NEW: Placeholder styles for empty image slots --- */
        .placeholder-image {
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            border: 1px solid #4b5563;
        }
        .placeholder-image::after {
            content: "?";
            opacity: 0.4;
            font-size: 2rem;
            font-weight: lighter;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 h-screen overflow-hidden">

    <!-- Floating Menu Button -->
    <button id="menu-button" class="fixed bottom-6 right-6 bg-indigo-600 hover:bg-indigo-700 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center z-40 transition-transform hover:scale-110">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
    </button>

    <!-- Centered Popup Menu -->
    <div id="popup-menu-overlay" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 flex items-center justify-center text-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none">
        <div id="popup-menu" class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-sm transform scale-95 transition-all duration-300">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-indigo-600 dark:text-indigo-400">Menu</h2>
                    <button id="close-menu-button" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <nav class="flex flex-col space-y-2">
                    <a href="#" class="album-title text-lg font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-3 rounded-lg transition-colors">Home</a>
                    <a href="#" class="album-title text-lg font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-3 rounded-lg transition-colors">My Favorites</a>
                    <a href="#" class="album-title text-lg font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-3 rounded-lg transition-colors">Discover</a>
                    <a href="#" class="album-title text-lg font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-3 rounded-lg transition-colors">Settings</a>
                </nav>
            </div>
        </div>
    </div>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 h-full flex flex-col">
        <!-- Search and Filters -->
        <div class="flex-shrink-0">
            <h1 class="text-4xl font-bold mb-4 text-center">Your Album Collection</h1>
            <div class="relative">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3"><svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg></span>
                <input id="search-input" type="text" placeholder="Search albums by title..." class="w-full pl-10 pr-10 py-3 border-2 border-gray-200 dark:border-gray-700 rounded-lg dark:bg-gray-800 focus:ring-indigo-500 focus:border-indigo-500">
                <button id="clear-search-button" class="absolute inset-y-0 right-0 flex items-center pr-3 hidden"><svg class="h-5 w-5 text-gray-400 hover:text-gray-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg></button>
                <div id="suggestions-box" class="absolute z-10 w-full mt-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg hidden"></div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4 mb-8">
                <select class="border-gray-200 dark:border-gray-700 rounded-lg p-2 dark:bg-gray-800 focus:ring-indigo-500 focus:border-indigo-500"><option>Genre</option></select>
                <select class="border-gray-200 dark:border-gray-700 rounded-lg p-2 dark:bg-gray-800 focus:ring-indigo-500 focus:border-indigo-500"><option>Artist</option></select>
                <select class="border-gray-200 dark:border-gray-700 rounded-lg p-2 dark:bg-gray-800 focus:ring-indigo-500 focus:border-indigo-500"><option>Year</option></select>
                <select class="border-gray-200 dark:border-gray-700 rounded-lg p-2 dark:bg-gray-800 focus:ring-indigo-500 focus:border-indigo-500"><option>Rating</option></select>
            </div>
        </div>

        <div class="relative flex-grow min-h-0">
            <!-- Albums Grid -->
            <div id="albums-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 h-full overflow-y-auto p-2">
                <!-- Album Card 1: 3 Images -->
                <div class="album-card bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden cursor-pointer transition-transform hover:-translate-y-1 select-none"
                    data-title="Cosmic Echoes"
                    data-description="A journey through swirling nebulae and distant galaxies, captured in sound. This album blends ambient synths with orchestral arrangements to create a truly otherworldly experience."
                    data-images='["https://image.civitai.com/xG1nkqKTMzGDvpLrqFT7WA/94583175-b06b-4cfa-af12-74a21d071860/original=true,quality=90,optimized=true/19c6a594-6f56-4a1f-a8da-eae7de06c8ef-0.jpeg", "https://image.civitai.com/xG1nkqKTMzGDvpLrqFT7WA/00bee383-844c-426c-858f-e1f98a33c9f9/original=true,quality=90,optimized=true/00012-322562131.jpeg", "https://image.civitai.com/xG1nkqKTMzGDvpLrqFT7WA/659f8e77-52fa-4b8c-892f-235905c3327f/original=true,quality=90,optimized=true/00008-2390625982.jpeg"]'>
                    <div class="relative overflow-hidden">
                        <div class="skeleton-loader absolute inset-0"></div>
                        <img data-src="https://image.civitai.com/xG1nkqKTMzGDvpLrqFT7WA/94583175-b06b-4cfa-af12-74a21d071860/original=true,quality=90,optimized=true/19c6a594-6f56-4a1f-a8da-eae7de06c8ef-0.jpeg" class="lazy-image image">
                        <div class="absolute inset-0"></div>
                    </div>
                    <div class="p-3"><h3 class="album-title text-lg font-semibold">Cosmic Echoes</h3></div>
                </div>
                <!-- Album Card 2: 1 Image -->
                <div class="album-card bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden cursor-pointer transition-transform hover:-translate-y-1 select-none"
                    data-title="Midnight Drive"
                    data-description="The perfect soundtrack for a late-night drive through city streets. Featuring smooth jazz, lo-fi beats, and a touch of soul."
                    data-images='["https://image.civitai.com/xG1nkqKTMzGDvpLrqFT7WA/54f07a4a-057d-49d7-9f6e-7b789a78a6e8/original=true,quality=90,optimized=true/00001-138887754.jpeg"]'>
                    <div class="relative overflow-hidden">
                        <div class="skeleton-loader absolute inset-0"></div>
                        <img data-src="https://image.civitai.com/xG1nkqKTMzGDvpLrqFT7WA/54f07a4a-057d-49d7-9f6e-7b789a78a6e8/original=true,quality=90,optimized=true/00001-138887754.jpeg" class="lazy-image image">
                        <div class="absolute inset-0"></div>
                    </div>
                    <div class="p-3"><h3 class="album-title text-lg font-semibold">Midnight Drive</h3></div>
                </div>
                <!-- Album Card 3: 4 Images -->
                <div class="album-card bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden cursor-pointer transition-transform hover:-translate-y-1 select-none"
                    data-title="City Lights"
                    data-description="An energetic and vibrant collection of pop anthems inspired by the never-ending pulse of the metropolis."
                    data-images='["https://image.civitai.com/xG1nkqKTMzGDvpLrqFT7WA/526a0f18-f04c-41e7-a026-7848c7075e39/original=true,quality=90,optimized=true/00002-289550292.jpeg", "https://image.civitai.com/xG1nkqKTMzGDvpLrqFT7WA/d89a7281-032f-45a4-9407-1e58a4f227b2/original=true,quality=90,optimized=true/00003-289550293.jpeg", "https://image.civitai.com/xG1nkqKTMzGDvpLrqFT7WA/813454a8-55a9-4d0f-897b-a252f44ee810/original=true,quality=90,optimized=true/00004-289550294.jpeg", "https://image.civitai.com/xG1nkqKTMzGDvpLrqFT7WA/237403a1-29a3-460d-835a-93512351a804/original=true,quality=90,optimized=true/00005-289550295.jpeg"]'>
                    <div class="relative overflow-hidden">
                        <div class="skeleton-loader absolute inset-0"></div>
                        <img data-src="https://image.civitai.com/xG1nkqKTMzGDvpLrqFT7WA/526a0f18-f04c-41e7-a026-7848c7075e39/original=true,quality=90,optimized=true/00002-289550292.jpeg" class="lazy-image image">
                        <div class="absolute inset-0"></div>
                    </div>
                    <div class="p-3"><h3 class="album-title text-lg font-semibold">City Lights</h3></div>
                </div>
                <!-- Add more album cards as needed -->
            </div>

            <!-- Backdrop for Detail View -->
            <div id="detail-backdrop" class="absolute inset-0 bg-gray-900/70 backdrop-blur-sm z-20"></div>

            <!-- MODIFIED Album Detail Container -->
            <div id="album-detail-container" class="absolute bottom-0 left-0 right-0 p-4 z-30">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-2xl border border-gray-200 dark:border-gray-700 grid grid-cols-1 md:grid-cols-2 gap-6 h-[20vh]">
                    <!-- Image Gallery -->
                    <div id="detail-image-gallery" class="grid grid-cols-4 gap-4 overflow-y-auto">
                        <!-- Images and placeholders will be dynamically inserted here -->
                    </div>
                    
                    <!-- Album Info (Read-Only) -->
                    <div class="flex flex-col">
                        <div class="flex justify-between items-start mb-4">
                             <div>
                                <h3 id="detail-title" class="text-2xl font-bold"></h3>
                                <p id="detail-image-count" class="text-sm text-gray-500 dark:text-gray-400 font-medium"></p>
                            </div>
                            <button id="close-detail-view" class="text-2xl font-bold text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 leading-none">&times;</button>
                        </div>
                        <div id="detail-description" class="text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-900/50 p-4 rounded-lg overflow-y-auto flex-grow">
                            <!-- Description will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Caching Album Data ---
            const albumCache = [];
            document.querySelectorAll('.album-card').forEach(card => {
                albumCache.push({
                    title: card.querySelector('.album-title').textContent.toLowerCase(),
                    element: card
                });
            });

            // --- Search Logic ---
            const searchInput = document.getElementById('search-input');
            const clearSearchButton = document.getElementById('clear-search-button');
            const suggestionsBox = document.getElementById('suggestions-box');

            const filterAlbums = (query) => {
                query = query.toLowerCase();
                albumCache.forEach(album => {
                    const isVisible = album.title.includes(query);
                    album.element.style.display = isVisible ? '' : 'none';
                });
            };

            const showSuggestions = (query) => {
                if (!query) {
                    suggestionsBox.classList.add('hidden');
                    return;
                }
                const matchedAlbums = albumCache
                    .filter(album => album.title.includes(query.toLowerCase()))
                    .map(album => album.title);

                if (matchedAlbums.length > 0) {
                    suggestionsBox.innerHTML = matchedAlbums
                        .map(title => `<div class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer">${title}</div>`)
                        .join('');
                    suggestionsBox.classList.remove('hidden');
                } else {
                    suggestionsBox.classList.add('hidden');
                }
            };

            searchInput.addEventListener('input', (e) => {
                const query = e.target.value;
                filterAlbums(query);
                showSuggestions(query);
                clearSearchButton.classList.toggle('hidden', !query);
            });

            clearSearchButton.addEventListener('click', () => {
                searchInput.value = '';
                filterAlbums('');
                suggestionsBox.classList.add('hidden');
                clearSearchButton.classList.add('hidden');
            });

            suggestionsBox.addEventListener('click', (e) => {
                if (e.target.tagName === 'DIV') {
                    searchInput.value = e.target.textContent;
                    filterAlbums(e.target.textContent);
                    suggestionsBox.classList.add('hidden');
                }
            });
            
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.relative')) {
                    suggestionsBox.classList.add('hidden');
                }
            });

            // --- Main Grid Lazy Loading Logic ---
            const lazyImages = document.querySelectorAll('#albums-grid .lazy-image');
            if ('IntersectionObserver' in window) {
                const imageObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            img.src = img.dataset.src;
                            img.onload = () => {
                                img.classList.add('loaded');
                                const skeleton = img.previousElementSibling;
                                if (skeleton && skeleton.classList.contains('skeleton-loader')) {
                                    setTimeout(() => skeleton.remove(), 400);
                                }
                            };
                            observer.unobserve(img);
                        }
                    });
                }, { root: document.getElementById('albums-grid'), rootMargin: '100px 0px', threshold: 0.01 });
                lazyImages.forEach(img => imageObserver.observe(img));
            } else { /* Fallback for older browsers */
                lazyImages.forEach(img => {
                    img.src = img.dataset.src;
                    img.classList.add('loaded');
                });
            }

            // --- NEW: Dedicated Lazy Loader for Detail View Images ---
            const lazyLoadDetailImages = () => {
                const detailImages = document.querySelectorAll('#detail-image-gallery .lazy-image');
                detailImages.forEach(img => {
                    img.src = img.dataset.src;
                    img.onload = () => {
                        img.classList.add('loaded');
                        const skeleton = img.previousElementSibling;
                        if (skeleton && skeleton.classList.contains('skeleton-loader')) {
                            setTimeout(() => skeleton.remove(), 400);
                        }
                    };
                });
            };

            // --- Popup Menu Logic ---
            const menuButton = document.getElementById('menu-button');
            const closeMenuButton = document.getElementById('close-menu-button');
            const menuOverlay = document.getElementById('popup-menu-overlay');
            const popupMenu = document.getElementById('popup-menu');

            const openMenu = () => {
                menuOverlay.classList.remove('pointer-events-none', 'opacity-0');
                popupMenu.classList.add('scale-100');
                popupMenu.classList.remove('scale-95');
            };

            const closeMenu = () => {
                menuOverlay.classList.add('opacity-0');
                setTimeout(() => menuOverlay.classList.add('pointer-events-none'), 300);
                popupMenu.classList.remove('scale-100');
                popupMenu.classList.add('scale-95');
            };

            menuButton.addEventListener('click', openMenu);
            closeMenuButton.addEventListener('click', closeMenu);
            menuOverlay.addEventListener('click', (e) => {
                if (e.target === menuOverlay) closeMenu();
            });

            // --- Expandable Album Detail Logic (MODIFIED) ---
            const albumCards = document.querySelectorAll('.album-card');
            const detailContainer = document.getElementById('album-detail-container');
            const detailBackdrop = document.getElementById('detail-backdrop');
            const closeDetailButton = document.getElementById('close-detail-view');

            let currentlyOpenCard = null;

            const closeDetailView = () => {
                if (!currentlyOpenCard) return;
                detailContainer.classList.remove('expanded');
                detailBackdrop.classList.remove('expanded');
                currentlyOpenCard.classList.remove('ring-2', 'ring-indigo-500', 'ring-offset-2', 'dark:ring-offset-gray-900');
                currentlyOpenCard = null;
            };

            albumCards.forEach(card => {
                card.addEventListener('click', () => {
                    if (currentlyOpenCard === card) {
                        closeDetailView();
                        return;
                    }
                    if (currentlyOpenCard) {
                        closeDetailView();
                    }
                    
                    currentlyOpenCard = card;
                    card.classList.add('ring-2', 'ring-indigo-500', 'ring-offset-2', 'dark:ring-offset-gray-900');

                    // --- Populate Detail View from data-* attributes ---
                    const title = card.dataset.title;
                    const description = card.dataset.description;
                    const images = JSON.parse(card.dataset.images || '[]');

                    document.getElementById('detail-title').textContent = title;
                    document.getElementById('detail-description').textContent = description;
                    document.getElementById('detail-image-count').textContent = `${images.length} Image${images.length !== 1 ? 's' : ''}`;

                    const gallery = document.getElementById('detail-image-gallery');
                    gallery.innerHTML = ''; // Clear previous content

                    // Create and append actual image elements
                    images.forEach(src => {
                        const imageWrapper = document.createElement('div');
                        imageWrapper.className = 'relative w-full overflow-hidden rounded-lg';
                        
                        imageWrapper.innerHTML = `
                            <div class="skeleton-loader absolute inset-0"></div>
                            <img data-src="${src}" class="lazy-image w-full h-full object-cover">
                            <div class="absolute inset-0"></div>
                        `;
                        gallery.appendChild(imageWrapper);
                    });

                    // --- NEW: Create and append placeholder elements ---
                    const maxGridItems = 4; // The detail gallery has 4 columns
                    if (images.length < maxGridItems) {
                        const placeholdersNeeded = maxGridItems - images.length;
                        for (let i = 0; i < placeholdersNeeded; i++) {
                            const placeholderWrapper = document.createElement('div');
                            placeholderWrapper.className = 'relative w-full overflow-hidden rounded-lg';
                            placeholderWrapper.innerHTML = `<div class="placeholder-image"></div>`;
                            gallery.appendChild(placeholderWrapper);
                        }
                    }

                    // Call the dedicated lazy loader for the new images
                    lazyLoadDetailImages();

                    detailContainer.classList.add('expanded');
                    detailBackdrop.classList.add('expanded');
                });
            });

            closeDetailButton.addEventListener('click', closeDetailView);
            detailBackdrop.addEventListener('click', closeDetailView);
        });
    </script>
</body>
</html>